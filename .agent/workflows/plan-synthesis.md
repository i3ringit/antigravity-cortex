---
name: workflows:plan-synthesis
description: Internal sub-workflow for the Plan Synthesis phase. Synthesizes findings and generates artifacts.
argument-hint: "[analysis_output] [original_request]"
---

<critical_rule>
This workflow is for WRITING ONLY. You must NOT execute code changes to implement the feature.
</critical_rule>

# Plan Synthesis Sub-Workflow

## Input

<analysis_output> $1 </analysis_output>
<original_request> $2 </original_request>

## Main Tasks

### 1. Parse and Sanitize Analysis Data

<thinking>
I need to parse the JSON output from the analysis phase.
If the JSON is malformed or missing, I must fall back to a "Just write the plan" mode using the original request.
I must also sanitize any input strings to ensure they don't break the markdown structure (e.g., untrusted backticks).
</thinking>

**Validation Logic:**
1.  **Preprocessing:** Strip any markdown code block wrappers (```json ... ```) from `<analysis_output>` to isolate the raw JSON string.
2.  Attempt to parse the cleaned string as JSON.
3.  **Fallback:** If parsing fails, log a warning and use specific "Minimal" template with just `<original_request>`.
4.  **Sanitization:** Escape unclosed backticks or special markdown characters in the findings before inserting them into templates.

### 2. Determine Complexity and Template

<thinking>
Based on the request and findings, choose the appropriate detail level: MINIMAL, MORE, or A LOT.
</thinking>

**Template Selection:**
- **MINIMAL:** Simple bugs, small tweaks.
- **MORE:** (Default) Standard features, multiple files.
- **A LOT:** Architectural changes, new systems.

### 3. Generate Implementation Plan Artifact

<thinking>
Write the `implementation_plan` artifact to `plans/<type>-<name>.md`.
Use the chosen template.
Ensure the output is visually distinct (Alerts, Collapsible sections).
</thinking>

**Template Requirements:**
- **Visuals:** Use GitHub Alerts (`> [!NOTE]`) for key info.
- **Hierarchy:** Clear H1, H2, H3 structure.
- **Collapsible:** Use `<details>` for deep research logs or long context.

#### ðŸ“„ MINIMAL Template
```markdown
# [Title]

> [!NOTE]
> generated by Antigravity

## Problem
[Description]

## Plan
- [ ] Step 1
- [ ] Step 2
```

#### ðŸ“‹ MORE Template (Standard)
```markdown
# [Title]

> [!NOTE]
> **Context:** 2026 | **Type:** Feature/Refactor

## Overview
[Executive Summary]

## Proposed Changes
### Component A
- [ ] Change 1
- [ ] Change 2

## Research Findings
<details>
<summary>View Analysis Details</summary>
[Sanitized Research Content]
</details>

## Verification
- [ ] Test command
```

#### ðŸ“š A LOT Template
(Comprehensive structure with Architecture, Risk, Phases - see upstream plan.md for reference)

### 4. Output

**Instruction:**
Use `write_to_file` with `IsArtifact: true` and `ArtifactMetadata.ArtifactType: 'implementation_plan'`.

**Return:** The ABSOLUTE PATH of the created artifact.
